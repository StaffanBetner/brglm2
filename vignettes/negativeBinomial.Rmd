---
title: "Negative binomial regression using **brglm2**"
author: "Euloge Clovis Kenne Pagui"
date: "12 June 2021"
output: rmarkdown::html_vignette
bibliography: brglm2.bib
vignette: >
  %\VignetteIndexEntry{Negative Binomial regression using brglm2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 6,
  fig.height = 6
)
```


# **brnb**
The [**brglm2**](https://github.com/ikosmidis/brglm2) R package provides `brnb` function for fitting negative binomial regression models using either maximum likelihood  or any of the various bias reduction methods described in `brglmFit`.  The mathematical details and numerical analyses   for mean and median bias reduction are given in @kenne:20.

This vignettes illustrates the use of `brnb` and of the associated methods, using the ames salmonella and  epileptic seizures examples in @kenne:20[, Sections 5.1 and 5.2]

# Ames salmonella data

 @kenne:20[, Section 5.1] provides a detailed description of the variables recorded in the data set.
```{r, echo = TRUE}
freq <- c(15, 16, 16, 27, 33, 20,
       21, 18, 26, 41, 38, 27,
       29, 21, 33, 60, 41, 42)
dose <- rep(c(0, 10, 33, 100, 333, 1000), 3)
observation <- rep(1:3, each = 6)
salmonella <- data.frame(freq, dose, observation)
```

## Maximum likelihood estimation

The following chunk of code reproduces @kenne:20[, Table 2]. The model uses the log link on the mean and identity transformation for dispersion parameter.
```{r, echo = TRUE}
salmo_ML <- brnb(freq ~ dose + log(dose + 10), link ="log", transformation = "identity",  type = "ML", data = salmonella)
## Estimated  regression and dispersion parameters
round(c(salmo_ML$coefficients,salmo_ML$dispersion), 2)
## Estimated standard errors
round(c(summary(salmo_ML)$coefficients[, 2], sqrt(salmo_ML$vcov.dispersion)), 2)
```

## Mean and median bias reduction

Fitting the model using mean-bias reducing adjusted score equations gives
```{r, echo = TRUE}
salmo_BRmean <- brnb(freq ~ dose + log(dose + 10), link = "log", transformation = "identity", type = "AS_mean", data = salmonella)
## Estimated  regression and dispersion parameters
round(c(salmo_BRmean$coefficients, salmo_BRmean$dispersion), 2)
## Estimated standard errors
round(c(summary(salmo_BRmean)$coefficients[, 2], sqrt(salmo_BRmean$vcov.dispersion)), 2)
```
The corresponding fit using median-bias reducing adjusted score equations is
```{r, echo = TRUE}
salmo_BRmedian <- brnb(freq ~ dose + log(dose + 10), link = "log", transformation = "identity", type = "AS_median", data = salmonella)
## Estimated  regression and dispersion parameters
round(c(salmo_BRmedian$coefficients, salmo_BRmedian$dispersion), 2)
## Estimated standard errors
round(c(summary(salmo_BRmedian)$coefficients[, 2], sqrt(salmo_BRmedian$vcov.dispersion)), 2)
```

## Mean bias correction

Fitting the model by correcting the maximum likelihood estimates
```{r, echo = TRUE}
salmo_BCmean <- brnb(freq ~ dose + log(dose + 10), link = "log", transformation = "identity", type = "correction", data = salmonella)
## Estimated  regression and dispersion parameters
round(c(salmo_BCmean$coefficients, salmo_BCmean$dispersion), 2)
## Estimated standard errors
round(c(summary(salmo_BCmean)$coefficients[, 2], sqrt(salmo_BCmean$vcov.dispersion)), 2)
```
The estimates of the regression coefficients  are comparable across methods. Mean and median bias reduced estimates of the shape parameter are comparable, but slightly different from the maximum likelihood estimate. This in turn reflects on the standard errors of the regression parameter estimates. 

## Mixed bias reduction

As with generalized linear models, a mixed adjustment could also be obtained in negative binomial regression, exploiting the orthogonality
of $\beta$ and $\phi$. However, the expected gain is negligible, as seen for generalized linear models. The mixed bias-reduced estimator is invariant under
linear combination of the regression coefficient and is invariant under monotone
transformation of the dispersion parameter.  
Fitting the model using mixed-bias reducing adjusted score equations gives
```{r, echo = TRUE}
salmo_BRmixed <- brnb(freq ~ dose + log(dose + 10), link = "log", transformation = "identity",   type = "AS_mixed", data = salmonella)
## Estimated  regression and dispersion parameters
round(c(salmo_BRmixed$coefficients, salmo_BRmixed$dispersion), 2)
## Estimated standard errors
round(c(summary(salmo_BRmixed)$coefficients[, 2], sqrt(salmo_BRmixed$vcov.dispersion)), 2)
```

# Epileptic seizures data

 @kenne:20[, Section 5.2] provides a detailed description of the variables recorded in the data set.
```{r, echo = TRUE}
library(MASS)
epil2 <- epil[epil$period == 1, ]
epil2["period"] <- rep(0, 59); epil2["y"] <- epil2["base"]; epil["time"] <- 1; 
epil2["time"] <- 4
epil2 <- rbind(epil, epil2)
epil2$pred <- unclass(epil2$trt) * (epil2$period > 0); epil2$subject <- factor(epil2$subject)
epil3 <- aggregate(epil2, list(epil2$subject, epil2$period > 0),
                   function(x) if(is.numeric(x)) sum(x) else x[1]) 
epil3$pred <- factor(epil3$pred,
                     labels = c("base", "placebo", "drug"))
contrasts(epil3$pred) <- structure(contr.sdif(3),
                                   dimnames = list(NULL, c("placebo-base", "drug-placebo")))
```

## Maximum likelihood estimation

The following chunk of code reproduces @kenne:20[, Figure 4]. The model uses the log link on the mean and identity transformation for dispersion parameter.
```{r, echo = TRUE}
epil3_ML <- brnb(y ~ -1+ factor(subject) + factor(pred),  data = epil3, type = "ML")
## Estimated of interest regression coefficients and dispersion parameters
round(c(epil3_ML$coefficients[-c(1:59)], epil3_ML$dispersion), 2)
## Estimated standard errors
round(c(summary(epil3_ML)$coefficients[-c(1:59), 2], sqrt(epil3_ML$vcov.dispersion)), 2)
```

## Mean and median bias reduction

Fitting the model using mean-bias reducing adjusted score equations gives
```{r, echo = TRUE}
epil3_BRmean <- brnb(y ~ -1+ factor(subject) + factor(pred),  data = epil3, type = "AS_mean")
## Estimated  of interest regression coefficients and dispersion parameters
round(c(epil3_BRmean$coefficients[-c(1:59)], epil3_BRmean$dispersion), 2)
## Estimated standard errors
round(c(summary(epil3_BRmean)$coefficients[-c(1:59), 2], sqrt(epil3_BRmean$vcov.dispersion)), 2)
```

The corresponding fit using median-bias reducing adjusted score equations is
```{r, echo = TRUE}
epil3_BRmedian <- brnb(y ~ -1+ factor(subject) + factor(pred),  data = epil3, type = "AS_median")
## Estimated  of interest regression coefficients and dispersion parameters
round(c(epil3_BRmedian$coefficients[-c(1:59)], epil3_BRmedian$dispersion), 2)
## Estimated standard errors
round(c(summary(epil3_BRmedian)$coefficients[-c(1:59), 2], sqrt(epil3_BRmedian$vcov.dispersion)), 2)
```

## Mean bias correction
```{r, echo = TRUE}
epil3_BCmean <- brnb(y ~ -1+ factor(subject) + factor(pred),  data = epil3, type = "correction")
## Estimated  of interest regression coefficients and dispersion parameters
round(c(epil3_BCmean$coefficients[-c(1:59)], epil3_BCmean$dispersion), 2)
## Estimated standard errors
round(c(summary(epil3_BCmean)$coefficients[-c(1:59), 2], sqrt(epil3_BCmean$vcov.dispersion)), 2)
```

The difference between mean and median
bias reduction  with respect to ML is particularly pronounced for the dispersion parameter. 

# Relevant resources
`?brglmFit` and `?brglm_control` contain quick descriptions of the various bias reduction methods supported in **brglm2**. The [`iteration`](https://cran.r-project.org/package=brglm2/brglm2.pdf) vignette describes the iteration and gives the mathematical details for the bias-reducing adjustments to the score functions for generalized linear models.

# Citation
If you found this vignette or **brglm2**, in general, useful, please consider citing **brglm2** and the associated paper. You can find information on how to do this by typing `citation("brglm2")`.

# References
